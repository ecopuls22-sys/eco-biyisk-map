name: Process New Idea

on:
  issues:
    types: [opened, labeled]
    
jobs:
  process-idea:
    if: contains(github.event.issue.labels.*.name, 'idea')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: üìä Parse issue data
        id: parse-idea
        run: |
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ body issue
          BODY="${{ github.event.issue.body }}"
          
          # –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ
          TITLE=$(echo "$BODY" | grep -A1 "üè∑Ô∏è –ù–∞–∑–≤–∞–Ω–∏–µ –∏–¥–µ–∏" | tail -1 | sed 's/<!--.*-->//g' | xargs)
          if [ -z "$TITLE" ]; then
            TITLE="${{ github.event.issue.title }}"
          fi
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
          if echo "$BODY" | grep -q "\[x\] –û–∑–µ–ª–µ–Ω–µ–Ω–∏–µ"; then
            CATEGORY="greening"
          elif echo "$BODY" | grep -q "\[x\] –ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ"; then
            CATEGORY="improvement"
          elif echo "$BODY" | grep -q "\[x\] –≠–∫–æ–ª–æ–≥–∏—è"; then
            CATEGORY="ecology"
          elif echo "$BODY" | grep -q "\[x\] –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞"; then
            CATEGORY="infrastructure"
          elif echo "$BODY" | grep -q "\[x\] –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è"; then
            CATEGORY="events"
          elif echo "$BODY" | grep -q "\[x\] –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã"; then
            CATEGORY="social"
          else
            CATEGORY="other"
          fi
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
          LAT=$(echo "$BODY" | grep -A1 "–®–∏—Ä–æ—Ç–∞" | tail -1 | sed 's/<!--.*-->//g' | grep -o '[0-9]*\.[0-9]*' || echo "52.5186")
          LON=$(echo "$BODY" | grep -A1 "–î–æ–ª–≥–æ—Ç–∞" | tail -1 | sed 's/<!--.*-->//g' | grep -o '[0-9]*\.[0-9]*' || echo "85.2076")
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –±—é–¥–∂–µ—Ç
          BUDGET=$(echo "$BODY" | grep -A1 "–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏" | tail -1 | sed 's/<!--.*-->//g' | grep -o '[0-9]*' || echo "0")
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
          DESCRIPTION=$(echo "$BODY" | sed -n '/üìù –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–¥–µ–∏/,/üéØ –¶–µ–ª–∏ –∏ –∑–∞–¥–∞—á–∏/p' | head -n -1 | tail -n +2 | xargs)
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ü–µ–ª–∏
          GOALS=$(echo "$BODY" | sed -n '/üéØ –¶–µ–ª–∏ –∏ –∑–∞–¥–∞—á–∏/,/‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ –ø–æ–ª—å–∑–∞/p' | head -n -1 | tail -n +2 | xargs)
          
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID
          ID=$(date +%s)
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ output
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT
          echo "lat=$LAT" >> $GITHUB_OUTPUT
          echo "lon=$LON" >> $GITHUB_OUTPUT
          echo "budget=$BUDGET" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "goals=$GOALS" >> $GITHUB_OUTPUT
          echo "id=$ID" >> $GITHUB_OUTPUT
          echo "author=${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT
          
      - name: üìÅ Read existing ideas
        id: read-ideas
        run: |
          if [ -f "data/ideas.json" ]; then
            DATA=$(cat data/ideas.json)
          else
            DATA="[]"
          fi
          echo "data=$DATA" >> $GITHUB_OUTPUT
          
      - name: ‚ú® Create new idea
        id: create-idea
        run: |
          # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –∏–¥–µ–∏
          NEW_IDEA=$(jq -n \
            --arg id "${{ steps.parse-idea.outputs.id }}" \
            --arg title "${{ steps.parse-idea.outputs.title }}" \
            --arg category "${{ steps.parse-idea.outputs.category }}" \
            --arg description "${{ steps.parse-idea.outputs.description }}" \
            --arg goals "${{ steps.parse-idea.outputs.goals }}" \
            --arg budget "${{ steps.parse-idea.outputs.budget }}" \
            --arg lat "${{ steps.parse-idea.outputs.lat }}" \
            --arg lon "${{ steps.parse-idea.outputs.lon }}" \
            --arg author "${{ steps.parse-idea.outputs.author }}" \
            '{
              id: ($id | tonumber),
              title: $title,
              category: $category,
              description: $description,
              goals: $goals,
              author: $author,
              authorRole: "resident",
              status: "new",
              votes: { up: 0, down: 0 },
              comments: 0,
              budget: ($budget | tonumber),
              location: [$lat | tonumber, $lon | tonumber],
              date: (now | strftime("%Y-%m-%d")),
              expertReview: null,
              votingId: null,
              issue_number: ${{ github.event.issue.number }}
            }')
          
          echo "new_idea=$NEW_IDEA" >> $GITHUB_OUTPUT
          
      - name: üîÑ Update ideas.json
        run: |
          # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∏ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
          UPDATED_DATA=$(echo '${{ steps.read-ideas.outputs.data }}' | jq \
            --argjson new "${{ steps.create-idea.outputs.new_idea }}" \
            '. + [$new]')
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
          echo "$UPDATED_DATA" > data/ideas.json
          
          # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º JSON –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
          jq '.' data/ideas.json > temp.json && mv temp.json data/ideas.json
          
      - name: üíæ Commit and push
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add data/ideas.json
          git commit -m "üí° –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–¥–µ—è: ${{ steps.parse-idea.outputs.title }} (issue #${{ github.event.issue.number }})"
          git push
          
      - name: üí¨ Comment on issue
        run: |
          COMMENT="üí° –ò–¥–µ—è **${{ steps.parse-idea.outputs.title }}** —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –±–∞–Ω–∫ –∏–¥–µ–π!\n\n**–î–µ—Ç–∞–ª–∏:**\n- –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${{ steps.parse-idea.outputs.category }}\n- –ë—é–¥–∂–µ—Ç: ${{ steps.parse-idea.outputs.budget }} —Ä—É–±.\n- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${{ steps.parse-idea.outputs.lat }}, ${{ steps.parse-idea.outputs.lon }}\n\n**–ü—Ä–æ—Ü–µ—Å—Å —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è:**\n1. üïê **–ú–æ–¥–µ—Ä–∞—Ü–∏—è** (3-5 –¥–Ω–µ–π) - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º\n2. üîç **–≠–∫—Å–ø–µ—Ä—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞** (7-14 –¥–Ω–µ–π) - –æ—Ü–µ–Ω–∫–∞ —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç–∏\n3. üó≥Ô∏è **–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ** (14-30 –¥–Ω–µ–π) - –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ\n4. ‚úÖ **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è** - –≤–∫–ª—é—á–µ–Ω–∏–µ –≤ –ø–ª–∞–Ω —Ä–∞–±–æ—Ç\n\n–°–ª–µ–¥–∏—Ç–µ –∑–∞ —Å—Ç–∞—Ç—É—Å–æ–º –≤ —ç—Ç–æ–º issue!"
          
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -d "{\"body\":\"$COMMENT\"}"
            
      - name: üè∑Ô∏è Add status label
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels \
            -d '{"labels":["status:new"]}'
            
      - name: üìß Check idea limit
        run: |
          # –ó–¥–µ—Å—å –º–æ–≥–ª–∞ –±—ã –±—ã—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –∏–¥–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          # –ù–æ –¥–ª—è –¥–µ–º–æ –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –∏–¥–µ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${{ github.event.issue.user.login }}"
