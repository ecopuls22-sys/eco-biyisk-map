name: Process New Object

on:
  issues:
    types: [opened, labeled]
    
jobs:
  process-object:
    if: contains(github.event.issue.labels.*.name, 'new-object')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: üìä Parse issue data
        id: parse
        run: |
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ body issue
          BODY="${{ github.event.issue.body }}"
          
          # –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ markdown (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)
          NAME=$(echo "$BODY" | grep -A1 "üè∑Ô∏è –ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞" | tail -1 | sed 's/<!--.*-->//g' | xargs)
          if [ -z "$NAME" ]; then
            NAME="${{ github.event.issue.title }}"
          fi
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞
          if echo "$BODY" | grep -q "\[x\] –î–µ—Ä–µ–≤–æ"; then
            TYPE="tree"
          elif echo "$BODY" | grep -q "\[x\] –ì–∞–∑–æ–Ω"; then
            TYPE="lawn"
          elif echo "$BODY" | grep -q "\[x\] –ö—É—Å—Ç–∞—Ä–Ω–∏–∫"; then
            TYPE="bush"
          else
            TYPE="tree"
          fi
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          if echo "$BODY" | grep -q "\[x\] –•–æ—Ä–æ—à–µ–µ"; then
            CONDITION="good"
          elif echo "$BODY" | grep -q "\[x\] –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ"; then
            CONDITION="normal"
          elif echo "$BODY" | grep -q "\[x\] –ü–ª–æ—Ö–æ–µ"; then
            CONDITION="bad"
          else
            CONDITION="normal"
          fi
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
          LAT=$(echo "$BODY" | grep -A1 "–®–∏—Ä–æ—Ç–∞" | tail -1 | sed 's/<!--.*-->//g' | grep -o '[0-9]*\.[0-9]*' || echo "52.5186")
          LON=$(echo "$BODY" | grep -A1 "–î–æ–ª–≥–æ—Ç–∞" | tail -1 | sed 's/<!--.*-->//g' | grep -o '[0-9]*\.[0-9]*' || echo "85.2076")
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
          DESCRIPTION=$(echo "$BODY" | sed -n '/üìù –û–ø–∏—Å–∞–Ω–∏–µ/,/üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è/p' | head -n -1 | tail -n +2 | xargs)
          
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID
          ID=$(date +%s)
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ output
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "condition=$CONDITION" >> $GITHUB_OUTPUT
          echo "lat=$LAT" >> $GITHUB_OUTPUT
          echo "lon=$LON" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "id=$ID" >> $GITHUB_OUTPUT
          
      - name: üìÅ Read existing data
        id: read-data
        run: |
          if [ -f "data/objects.json" ]; then
            DATA=$(cat data/objects.json)
          else
            DATA="[]"
          fi
          echo "data=$DATA" >> $GITHUB_OUTPUT
          
      - name: ‚ú® Create new object
        id: create-object
        run: |
          # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
          NEW_OBJECT=$(jq -n \
            --arg id "${{ steps.parse.outputs.id }}" \
            --arg name "${{ steps.parse.outputs.name }}" \
            --arg type "${{ steps.parse.outputs.type }}" \
            --arg condition "${{ steps.parse.outputs.condition }}" \
            --arg lat "${{ steps.parse.outputs.lat }}" \
            --arg lon "${{ steps.parse.outputs.lon }}" \
            --arg description "${{ steps.parse.outputs.description }}" \
            '{
              id: ($id | tonumber),
              name: $name,
              type: $type,
              condition: $condition,
              coords: [$lat | tonumber, $lon | tonumber],
              description: $description,
              date: (now | strftime("%Y-%m-%d"))
            }')
          
          echo "new_object=$NEW_OBJECT" >> $GITHUB_OUTPUT
          
      - name: üîÑ Update objects.json
        run: |
          # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∏ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
          UPDATED_DATA=$(echo '${{ steps.read-data.outputs.data }}' | jq \
            --argjson new "${{ steps.create-object.outputs.new_object }}" \
            '. + [$new]')
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
          echo "$UPDATED_DATA" > data/objects.json
          
          # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º JSON –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
          jq '.' data/objects.json > temp.json && mv temp.json data/objects.json
          
      - name: üíæ Commit and push
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add data/objects.json
          git commit -m "üå≥ –î–æ–±–∞–≤–ª–µ–Ω –æ–±—ä–µ–∫—Ç: ${{ steps.parse.outputs.name }} (–∏–∑ issue #${{ github.event.issue.number }})"
          git push
          
      - name: üí¨ Comment on issue
        run: |
          COMMENT="‚úÖ –û–±—ä–µ–∫—Ç **${{ steps.parse.outputs.name }}** —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –∫–∞—Ä—Ç—É!\n\n**–î–µ—Ç–∞–ª–∏:**\n- –¢–∏–ø: ${{ steps.parse.outputs.type }}\n- –°–æ—Å—Ç–æ—è–Ω–∏–µ: ${{ steps.parse.outputs.condition }}\n- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${{ steps.parse.outputs.lat }}, ${{ steps.parse.outputs.lon }}\n\n–ö–∞—Ä—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–∏–Ω—É—Ç."
          
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -d "{\"body\":\"$COMMENT\"}"
            
      - name: üîí Close issue
        run: |
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }} \
            -d '{"state":"closed", "labels":["added-to-map"]}'
