name: Process New Problem

on:
  issues:
    types: [opened, labeled]
    
jobs:
  process-problem:
    if: contains(github.event.issue.labels.*.name, 'problem')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: üìä Parse issue data
        id: parse-problem
        run: |
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ body issue
          BODY="${{ github.event.issue.body }}"
          
          # –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ
          TITLE=$(echo "$BODY" | grep -A1 "üè∑Ô∏è –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã" | tail -1 | sed 's/<!--.*-->//g' | xargs)
          if [ -z "$TITLE" ]; then
            TITLE="${{ github.event.issue.title }}"
          fi
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø—Ä–æ–±–ª–µ–º—ã
          if echo "$BODY" | grep -q "\[x\] –î–µ—Ä–µ–≤–æ"; then
            TYPE="tree"
          elif echo "$BODY" | grep -q "\[x\] –ì–∞–∑–æ–Ω"; then
            TYPE="lawn"
          elif echo "$BODY" | grep -q "\[x\] –ö—É—Å—Ç–∞—Ä–Ω–∏–∫"; then
            TYPE="bush"
          elif echo "$BODY" | grep -q "\[x\] –û–≥—Ä–∞–¥–∞"; then
            TYPE="fence"
          elif echo "$BODY" | grep -q "\[x\] –ú—É—Å–æ—Ä"; then
            TYPE="garbage"
          elif echo "$BODY" | grep -q "\[x\] –û—Å–≤–µ—â–µ–Ω–∏–µ"; then
            TYPE="lighting"
          else
            TYPE="other"
          fi
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
          LAT=$(echo "$BODY" | grep -A1 "–®–∏—Ä–æ—Ç–∞" | tail -1 | sed 's/<!--.*-->//g' | grep -o '[0-9]*\.[0-9]*' || echo "52.5186")
          LON=$(echo "$BODY" | grep -A1 "–î–æ–ª–≥–æ—Ç–∞" | tail -1 | sed 's/<!--.*-->//g' | grep -o '[0-9]*\.[0-9]*' || echo "85.2076")
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
          DESCRIPTION=$(echo "$BODY" | sed -n '/üìù –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ/,/üöß –°—Ä–æ—á–Ω–æ—Å—Ç—å/p' | head -n -1 | tail -n +2 | xargs)
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ä–æ—á–Ω–æ—Å—Ç—å
          if echo "$BODY" | grep -q "\[x\] –ö—Ä–∏—Ç–∏—á–Ω–æ"; then
            PRIORITY="critical"
          elif echo "$BODY" | grep -q "\[x\] –í—ã—Å–æ–∫–∞—è"; then
            PRIORITY="high"
          elif echo "$BODY" | grep -q "\[x\] –°—Ä–µ–¥–Ω—è—è"; then
            PRIORITY="medium"
          else
            PRIORITY="low"
          fi
          
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID
          ID=$(date +%s)
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ output
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "lat=$LAT" >> $GITHUB_OUTPUT
          echo "lon=$LON" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "priority=$PRIORITY" >> $GITHUB_OUTPUT
          echo "id=$ID" >> $GITHUB_OUTPUT
          echo "author=${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT
          
      - name: üìÅ Read existing problems
        id: read-problems
        run: |
          if [ -f "data/problems.json" ]; then
            DATA=$(cat data/problems.json)
          else
            DATA="[]"
          fi
          echo "data=$DATA" >> $GITHUB_OUTPUT
          
      - name: ‚ú® Create new problem
        id: create-problem
        run: |
          # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –ø—Ä–æ–±–ª–µ–º—ã
          NEW_PROBLEM=$(jq -n \
            --arg id "${{ steps.parse-problem.outputs.id }}" \
            --arg title "${{ steps.parse-problem.outputs.title }}" \
            --arg type "${{ steps.parse-problem.outputs.type }}" \
            --arg description "${{ steps.parse-problem.outputs.description }}" \
            --arg priority "${{ steps.parse-problem.outputs.priority }}" \
            --arg lat "${{ steps.parse-problem.outputs.lat }}" \
            --arg lon "${{ steps.parse-problem.outputs.lon }}" \
            --arg author "${{ steps.parse-problem.outputs.author }}" \
            '{
              id: ($id | tonumber),
              title: $title,
              type: $type,
              description: $description,
              status: "new",
              priority: $priority,
              location: [$lat | tonumber, $lon | tonumber],
              author: $author,
              date: (now | strftime("%Y-%m-%d")),
              votes: 0,
              comments: 0,
              issue_number: ${{ github.event.issue.number }}
            }')
          
          echo "new_problem=$NEW_PROBLEM" >> $GITHUB_OUTPUT
          
      - name: üîÑ Update problems.json
        run: |
          # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∏ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
          UPDATED_DATA=$(echo '${{ steps.read-problems.outputs.data }}' | jq \
            --argjson new "${{ steps.create-problem.outputs.new_problem }}" \
            '. + [$new]')
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
          echo "$UPDATED_DATA" > data/problems.json
          
          # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º JSON –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
          jq '.' data/problems.json > temp.json && mv temp.json data/problems.json
          
      - name: üíæ Commit and push
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add data/problems.json
          git commit -m "‚ö†Ô∏è –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞: ${{ steps.parse-problem.outputs.title }} (issue #${{ github.event.issue.number }})"
          git push
          
      - name: üí¨ Comment on issue
        run: |
          COMMENT="‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ **${{ steps.parse-problem.outputs.title }}** —É—Å–ø–µ—à–Ω–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞!\n\n**–î–µ—Ç–∞–ª–∏:**\n- –¢–∏–ø: ${{ steps.parse-problem.outputs.type }}\n- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${{ steps.parse-problem.outputs.priority }}\n- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${{ steps.parse-problem.outputs.lat }}, ${{ steps.parse-problem.outputs.lon }}\n\n–ü—Ä–æ–±–ª–µ–º–∞ –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç. –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Å—Ç–∞—Ç—É—Å–æ–º –≤ —ç—Ç–æ–º issue!"
          
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -d "{\"body\":\"$COMMENT\"}"
            
      - name: üè∑Ô∏è Add status label
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels \
            -d '{"labels":["status:new"]}'
